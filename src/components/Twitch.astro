<div id="twitch-wrap" class="is-offline">
  <div id="twitch-embed"></div>

  <div id="twitch-offline" hidden>Iâ€™m offline right now.</div>
</div>

<script type="module">
  const channel = "knrc";
  const parent = location.hostname;

  const wrap = document.getElementById("twitch-wrap");
  const embed = document.getElementById("twitch-embed");
  const offline = document.getElementById("twitch-offline");

  async function update() {
    const res = await fetch(
      `/api/twitch/live?channel=${encodeURIComponent(channel)}`,
    );
    const { live } = await res.json();

    if (!live) {
      wrap.classList.remove("is-live");
      wrap.classList.add("is-offline");

      // Remove the iframe so it can't reserve anything / keep playing audio
      embed.replaceChildren();

      offline.hidden = false;
      return;
    }

    wrap.classList.add("is-live");
    wrap.classList.remove("is-offline");

    offline.hidden = true;

    if (!embed.querySelector("iframe")) {
      const iframe = document.createElement("iframe");
      iframe.src = `https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&parent=${encodeURIComponent(parent)}`;
      iframe.allowFullscreen = true;
      embed.appendChild(iframe);
    }
  }

  update();
  setInterval(update, 60_000);
</script>

<style>
  /* Default: offline => no reserved space */
  #twitch-wrap {
    width: 100%;
    min-width: 0;

    max-width: 900px;
    margin: 24px auto 0;
    justify-self: stretch;
    align-self: flex-start;
  }

  #twitch-embed {
    min-width: 0;
    width: 100%;
  }

  /* Only reserve 16:9 space while live */
  #twitch-wrap.is-live #twitch-embed {
    width: 100%;
    aspect-ratio: 16 / 9;
  }

  /* Make the iframe fill the aspect-ratio box */
  #twitch-embed iframe {
    width: 100%;
    height: 100%;
    border: 0;
    display: block;
  }
</style>
